# Prompt Completo para Criar API Backend de Loja FiveM

**IMPORTANTE: Crie APENAS o backend/API REST. NÃƒO crie interfaces frontend, dashboards ou pÃ¡ginas web.**

Desenvolva uma API REST robusta para loja de jogos FiveM com sistema de pagamentos PIX (EfiBank), gerenciamento de usuÃ¡rios, sistema de carrinho e integraÃ§Ã£o instantÃ¢nea com o servidor. A API deve ser deployment-ready no Replit e retornar apenas JSON.

## ğŸ“‹ ESTRUTURA DO PROJETO

```
fivem-store-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ authController.js
â”‚   â”‚   â”œâ”€â”€ userController.js
â”‚   â”‚   â”œâ”€â”€ productController.js
â”‚   â”‚   â”œâ”€â”€ cartController.js
â”‚   â”‚   â”œâ”€â”€ paymentController.js
â”‚   â”‚   â”œâ”€â”€ webhookController.js
â”‚   â”‚   â”œâ”€â”€ adminController.js
â”‚   â”‚   â””â”€â”€ serverController.js
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â”œâ”€â”€ validation.js
â”‚   â”‚   â”œâ”€â”€ rateLimiter.js
â”‚   â”‚   â””â”€â”€ errorHandler.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ User.js
â”‚   â”‚   â”œâ”€â”€ Product.js
â”‚   â”‚   â”œâ”€â”€ Transaction.js
â”‚   â”‚   â”œâ”€â”€ Cart.js
â”‚   â”‚   â””â”€â”€ Grant.js
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â”œâ”€â”€ users.js
â”‚   â”‚   â”œâ”€â”€ products.js
â”‚   â”‚   â”œâ”€â”€ cart.js
â”‚   â”‚   â”œâ”€â”€ payments.js
â”‚   â”‚   â”œâ”€â”€ webhooks.js
â”‚   â”‚   â”œâ”€â”€ admin.js
â”‚   â”‚   â””â”€â”€ server.js
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ efiService.js
â”‚   â”‚   â”œâ”€â”€ databaseService.js
â”‚   â”‚   â”œâ”€â”€ fivemService.js
â”‚   â”‚   â””â”€â”€ emailService.js
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.js
â”‚   â”‚   â”œâ”€â”€ crypto.js
â”‚   â”‚   â””â”€â”€ validators.js
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.js
â”‚   â”‚   â”œâ”€â”€ efibank.js
â”‚   â”‚   â””â”€â”€ server.js
â”‚   â””â”€â”€ app.js
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ auth.test.js
â”‚   â”œâ”€â”€ users.test.js
â”‚   â”œâ”€â”€ products.test.js
â”‚   â”œâ”€â”€ cart.test.js
â”‚   â”œâ”€â”€ payments.test.js
â”‚   â””â”€â”€ admin.test.js
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ API.md
â”‚   â””â”€â”€ SETUP.md
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ seed.js
â”‚   â”œâ”€â”€ migrate.js
â”‚   â””â”€â”€ test-all.sh
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ server.js
â””â”€â”€ README.md
```

## ğŸ—„ï¸ ESTRUTURA DO BANCO DE DADOS

**Tabelas necessÃ¡rias (SQLite para Replit):**

```sql
-- UsuÃ¡rios do sistema
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('user', 'admin', 'super_admin') DEFAULT 'user',
    fivem_identifier VARCHAR(100),
    discord_id VARCHAR(50),
    coins INTEGER DEFAULT 0,
    vip_level VARCHAR(20) DEFAULT 'none',
    vip_expires DATETIME NULL,
    banned BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Produtos da loja
CREATE TABLE products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    type ENUM('coins', 'vip', 'vehicle', 'weapon', 'item') NOT NULL,
    data JSON, -- Dados especÃ­ficos do produto
    active BOOLEAN DEFAULT TRUE,
    stock INTEGER DEFAULT -1, -- -1 = ilimitado
    category VARCHAR(50),
    image_url VARCHAR(255),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Carrinho de compras
CREATE TABLE cart_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

-- TransaÃ§Ãµes de pagamento
CREATE TABLE transactions (
    id VARCHAR(36) PRIMARY KEY,
    user_id INTEGER NOT NULL,
    payment_id VARCHAR(100),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'BRL',
    status ENUM('pending', 'approved', 'cancelled', 'failed') DEFAULT 'pending',
    payment_method VARCHAR(20) DEFAULT 'pix',
    qr_code TEXT,
    expires_at DATETIME,
    products JSON, -- Produtos comprados
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Entregas/concessÃµes
CREATE TABLE grants (
    id VARCHAR(36) PRIMARY KEY,
    transaction_id VARCHAR(36),
    user_id INTEGER NOT NULL,
    grant_type VARCHAR(20) NOT NULL,
    grant_data JSON,
    status ENUM('pending', 'delivered', 'failed') DEFAULT 'pending',
    granted_by INTEGER, -- admin user id
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (granted_by) REFERENCES users(id)
);

-- Logs do sistema
CREATE TABLE activity_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL,
    details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## ğŸš€ ESPECIFICAÃ‡Ã•ES DA API

### **AUTENTICAÃ‡ÃƒO E USUÃRIOS**

```javascript
// POST /api/auth/register - Registrar usuÃ¡rio
{
  "username": "player123",
  "email": "player@email.com",
  "password": "senha123",
  "fivem_identifier": "steam:110000103fa1337",
  "discord_id": "123456789012345678"
}

// POST /api/auth/login - Login
{
  "email": "player@email.com",
  "password": "senha123"
}

// GET /api/auth/me - Dados do usuÃ¡rio logado
// PUT /api/auth/me - Atualizar dados do usuÃ¡rio
// POST /api/auth/change-password - Alterar senha

// GET /api/users/:id - Dados pÃºblicos do usuÃ¡rio
// GET /api/users/search?q=username - Buscar usuÃ¡rios
```

### **PRODUTOS E LOJA**

```javascript
// GET /api/products - Listar produtos (com filtros)
// GET /api/products/:id - Detalhes do produto
// GET /api/products/categories - Listar categorias
// GET /api/products/featured - Produtos em destaque

// ADMIN endpoints:
// POST /api/admin/products - Criar produto
// PUT /api/admin/products/:id - Atualizar produto
// DELETE /api/admin/products/:id - Remover produto
```

### **SISTEMA DE CARRINHO**

```javascript
// GET /api/cart - Ver carrinho do usuÃ¡rio logado
// POST /api/cart/add - Adicionar produto
{
  "product_id": 1,
  "quantity": 2
}

// PUT /api/cart/item/:id - Atualizar quantidade
// DELETE /api/cart/item/:id - Remover item
// DELETE /api/cart/clear - Limpar carrinho
// GET /api/cart/stats - EstatÃ­sticas do carrinho
// POST /api/cart/checkout - Finalizar compra
```

### **PAGAMENTOS E WEBHOOKS**

```javascript
// POST /api/payments/create - Criar pagamento
{
  "items": [{"product_id": 1, "quantity": 2}],
  "payment_method": "pix"
}

// GET /api/payments/:id - Status do pagamento
// POST /api/webhooks/efibank - Webhook EfiBank
// POST /api/webhooks/payment - Webhook genÃ©rico
```

### **ADMINISTRAÃ‡ÃƒO**

```javascript
// GET /api/admin/users - Listar usuÃ¡rios
// PUT /api/admin/users/:id/ban - Banir usuÃ¡rio
// PUT /api/admin/users/:id/unban - Desbanir usuÃ¡rio
// POST /api/admin/users/:id/grant - Conceder itens

// GET /api/admin/transactions - Todas transaÃ§Ãµes
// GET /api/admin/analytics - RelatÃ³rios
// GET /api/admin/logs - Logs do sistema

// POST /api/admin/grant - ConcessÃ£o manual
{
  "user_id": 1,
  "grant_type": "coins",
  "grant_data": {"amount": 1000},
  "reason": "CompensaÃ§Ã£o por bug"
}
```

### **INTEGRAÃ‡ÃƒO FIVEM**

```javascript
// POST /api/server/deliver - Entrega instantÃ¢nea
{
  "user_identifier": "steam:110000103fa1337",
  "grant_type": "coins",
  "grant_data": {"amount": 1000},
  "transaction_id": "uuid"
}

// GET /api/server/user/:identifier/online - Verificar se estÃ¡ online
// POST /api/server/user/:identifier/kick - Expulsar usuÃ¡rio
// GET /api/server/status - Status do servidor FiveM
```

## ğŸ“¦ DEPENDÃŠNCIAS (package.json)

```json
{
  "name": "fivem-store-api",
  "version": "2.0.0",
  "description": "API completa para loja FiveM com pagamentos PIX",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "migrate": "node scripts/migrate.js",
    "seed": "node scripts/seed.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "express-rate-limit": "^6.7.0",
    "helmet": "^6.1.5",
    "cors": "^2.8.5",
    "morgan": "^1.10.0",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.0",
    "zod": "^3.21.4",
    "sqlite3": "^5.1.6",
    "uuid": "^9.0.0",
    "axios": "^1.4.0",
    "multer": "^1.4.5",
    "sharp": "^0.32.1",
    "nodemailer": "^6.9.1",
    "qrcode": "^1.5.3",
    "dotenv": "^16.0.3",
    "winston": "^3.8.2"
  },
  "devDependencies": {
    "nodemon": "^2.0.22",
    "jest": "^29.5.0",
    "supertest": "^6.3.3"
  }
}
```

## ğŸ” VARIÃVEIS DE AMBIENTE (.env.example)

```env
# Servidor
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# JWT
JWT_SECRET=sua-chave-jwt-super-secreta-aqui
JWT_EXPIRES_IN=7d

# Banco de dados
DATABASE_URL=./database.sqlite

# EfiBank
EFI_CLIENT_ID=seu-client-id-efibank
EFI_CLIENT_SECRET=seu-client-secret-efibank
EFI_PIX_KEY=sua-chave-pix
EFI_WEBHOOK_URL=https://sua-url.replit.app/api/webhooks/efibank
EFI_WEBHOOK_SECRET=seu-token-webhook-secreto

# FiveM Server
FIVEM_SERVER_URL=http://seu-servidor-fivem:30120
FIVEM_SERVER_TOKEN=token-do-seu-servidor-fivem

# Admin
SUPER_ADMIN_EMAIL=admin@sua-loja.com
SUPER_ADMIN_PASSWORD=senha-admin-segura

# Email (opcional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=seu-email@gmail.com
SMTP_PASS=sua-senha-app

# Rate Limiting
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100
```

## ğŸ›¡ï¸ RECURSOS DE SEGURANÃ‡A OBRIGATÃ“RIOS

1. **AutenticaÃ§Ã£o JWT** com refresh tokens
2. **Rate limiting** em todos os endpoints
3. **ValidaÃ§Ã£o de dados** com Zod
4. **Hash de senhas** com bcrypt
5. **Headers de seguranÃ§a** com Helmet
6. **CORS** configurado
7. **Logs de atividade** completos
8. **SanitizaÃ§Ã£o de dados**
9. **PrevenÃ§Ã£o de SQL injection**
10. **Middleware de erro** robusto

## ğŸ§ª SISTEMA DE TESTES

Inclua testes automatizados para:

- âœ… AutenticaÃ§Ã£o (register, login, JWT)
- âœ… CRUD de usuÃ¡rios
- âœ… CRUD de produtos
- âœ… Sistema de carrinho
- âœ… Pagamentos e webhooks
- âœ… Endpoints administrativos
- âœ… IntegraÃ§Ã£o FiveM
- âœ… Rate limiting
- âœ… ValidaÃ§Ãµes
- âœ… Casos de erro

## ğŸ”§ RECURSOS ESPECÃFICOS DO FIVEM

### **Entrega InstantÃ¢nea de Itens:**

```javascript
// Detectar quando usuÃ¡rio estÃ¡ online
// Entregar coins, VIP, veÃ­culos automaticamente
// Log de todas as entregas
// Retry automÃ¡tico se jogador estiver offline
// Webhook para confirmar entrega no servidor
```

### **Tipos de Produtos Suportados:**

1. **Coins** - Moeda do servidor
2. **VIP** - Diferentes nÃ­veis (Bronze, Prata, Ouro, Diamante)
3. **VeÃ­culos** - Spawn direto na garagem
4. **Armas** - Entrega no inventÃ¡rio
5. **Items** - Items customizados do servidor
6. **Properties** - Casas/empresas
7. **Jobs** - Empregos especiais

## ğŸ“Š ENDPOINTS DE RELATÃ“RIOS (JSON APENAS)

```javascript
// GET /api/admin/analytics/sales - Vendas por perÃ­odo
// GET /api/admin/analytics/products - Produtos mais vendidos  
// GET /api/admin/analytics/users - UsuÃ¡rios mais ativos
// GET /api/admin/analytics/revenue - Revenue analytics
// GET /api/admin/analytics/conversions - ConversÃ£o de pagamentos
// GET /api/admin/logs/errors - Logs de erro
```

## ğŸš€ DEPLOY NO REPLIT

Configure para funcionar imediatamente no Replit:

1. **Auto-inicializaÃ§Ã£o** do banco de dados
2. **MigraÃ§Ã£o automÃ¡tica** das tabelas
3. **Seed de dados** inicial
4. **Health check** endpoint
5. **ConfiguraÃ§Ã£o de ambiente** automÃ¡tica
6. **Keep-alive** para evitar sleep
7. **HTTPS** ready

## ğŸ“– DOCUMENTAÃ‡ÃƒO AUTOMÃTICA DA API

Configure endpoints de documentaÃ§Ã£o:

```javascript
// GET /api/docs - DocumentaÃ§Ã£o Swagger/OpenAPI
// GET /api/health - Health check com status da API
// GET /api/version - VersÃ£o da API
// GET /api/endpoints - Lista todos endpoints disponÃ­veis
```

Inclua:
- Swagger/OpenAPI spec
- Exemplos de request/response JSON
- CÃ³digos de erro
- AutenticaÃ§Ã£o required
- Rate limits por endpoint

## ğŸ¯ REQUISITOS FINAIS

A API deve ser:

- âœ… **Plug-and-play** no Replit
- âœ… **EscalÃ¡vel** e bem estruturada
- âœ… **Segura** com todas as prÃ¡ticas de seguranÃ§a
- âœ… **TestÃ¡vel** com suite completa de testes
- âœ… **Documentada** com exemplos claros
- âœ… **MonitorÃ¡vel** com logs estruturados
- âœ… **IntegrÃ¡vel** com qualquer servidor FiveM
- âœ… **Robusta** com tratamento de erros completo

**IMPORTANTE**: 

1. **APENAS BACKEND/API** - NÃƒO crie pÃ¡ginas HTML, dashboards visuais, ou interfaces frontend
2. **APENAS ENDPOINTS JSON** - Todos os retornos devem ser em formato JSON
3. **API REST PURA** - Foque exclusivamente nos endpoints REST
4. **SEM VIEWS/TEMPLATES** - NÃ£o inclua engines de template ou renderizaÃ§Ã£o de pÃ¡ginas
5. **DOCUMENTAÃ‡ÃƒO VIA API** - Use Swagger/OpenAPI acessÃ­vel via endpoint JSON

Implemente TODOS os endpoints listados, com validaÃ§Ã£o completa, tratamento de erros, logs, e testes. A API deve estar 100% funcional para uso em produÃ§Ã£o imediatamente apÃ³s o deploy no Replit.

FaÃ§a o cÃ³digo mais limpo, organizado e profissional possÃ­vel. Use as melhores prÃ¡ticas de desenvolvimento Node.js/Express para APIs REST.